###################### Filebeat Configuration #########################
#
# You can find the full configuration reference here:
# https://www.elastic.co/guide/en/beats/filebeat/index.html
#
# ================================== General ===================================

# The name of the shipper that publishes the network data. It can be used to group
# all the transactions sent by a single shipper in the web interface.
# name:

# The tags of the shipper are included in their own field with each transaction published.
tags: ["{APP_NAME}", "universal_integrations"]

# Optional fields that you can specify to add additional information to the output.
fields:
  app: {APP_NAME}
  commit_hash: {STS_COMMIT_HASH}
  env: {ENV}
  flavor: {FLAVOR}

# ============================== Filebeat modules ==============================

filebeat.config.modules:
  # Set to true to enable config reloading
  reload.enabled: true
  reload.period: 60s

  # Glob pattern for configuration loading
  path: ${path.config}/modules.d/*.yml

# ================================= Processors =================================

# Configure processors to enhance or manipulate events generated by the beat.

processors:
  - add_id: ~
  - add_cloud_metadata:
      providers: aws

# ============================== Filebeat inputs ===============================

filebeat.inputs:
  # Ingest application logs.
  - id: universal_integrations.service
    type: journald
    include_matches:
      - _SYSTEMD_UNIT=universal_integrations.service
    seek: head
    paths: []
    fields_under_root: true
    fields:
      event.dataset: universal_integrations.log
    processors:
      - decode_json_fields:
          fields: ["message"]
          target: ""
          overwrite_keys: true
          add_error_key: true
      - if:
          regexp:
            message: "^Traceback.*"
        then:
          add_fields:
            target: ""
            fields:
              log.level: error

  # Ingest CloudFormation Init (bootstrap) logs.
  - id: bootstrap.cfn-init
    type: filestream
    enabled: true
    paths:
      - /var/log/cfn-hup.log*
      - /var/log/cfn-init.log*
      - /var/log/cfn-init-cmd.log*
      - /var/log/cloud-init.log*
      - /var/log/cloud-init-output.log*
    exclude_files: ['.gz$']
    exclude_lines:
      - '(\++)$'
      - '(=+)$'
      - '(-+)$'
      - '(\*+)$'
    fields_under_root: true
    fields:
      event.dataset: bootstrap.cfn-init

  # Ingest uWSGI request logs. Enable only as needed for debugging.
  - id: uwsgi.request
    type: filestream
    enabled: false
    paths:
      - /var/log/uwsgi/req.log*
    exclude_files: ['.gz$']
    fields_under_root: true
    fields:
      event.dataset: uwsgi.request

# ================================== Outputs ===================================

# ---------------------------- Elasticsearch Output ----------------------------
output.elasticsearch.hosts: ["localhost:9200"]
output.elasticsearch.index: "impel-{FLAVOR}-applogs-%{[agent.version]}"

# ======================= Elasticsearch template setting =======================

setup.template.name: "impel-{FLAVOR}-applogs-%{[agent.version]}"
setup.template.pattern: "impel-{FLAVOR}-applogs-%{[agent.version]}"

setup.ilm.enabled: true  # Enables ILM for new indices created by this beat.
setup.ilm.check_exists: true
setup.ilm.overwrite: false
setup.ilm.policy_name: "impel-{FLAVOR}-applogs"  # Use the policy we've pre-defined in ES.

# =================================== Kibana ===================================

setup.kibana.space.id: {FLAVOR}

# =============================== Elastic Cloud ================================

# These settings simplify using Filebeat with the Elastic Cloud (https://cloud.elastic.co/).
cloud.id: "spincar:dXMtZWFzdC0xLmF3cy5mb3VuZC5pbyRjYzc0MWMwOTBkYzY0ZWFjOTdhYTg0MjMxNjUyNzk2OCQ0MjQ0ZDY5M2M1ZDc0ZWY2YjA0ZWY4ODJkZDQ3NGVkYw=="
cloud.auth: "{ELASTIC_ID}:{ELASTIC_AUTH}"
