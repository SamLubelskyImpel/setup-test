AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: tekion crm integration

Parameters:
  Environment:
    Description: The name of the runtime environment
    Type: String
    AllowedPattern: "^[a-zA-z0-9-]+$"
    ConstraintDescription: Must contain only lowercase, uppercase, numbers, or hyphens

Conditions:
  IsProd:
    Fn::Equals:
      - Ref: AWS::AccountId
      - 196800776222
  IsUsEast1: !Equals [ !Ref "AWS::Region", "us-east-1" ]

Globals:
  Function:
    Runtime: python3.12
    Environment:
      Variables:
        AWS_ACCOUNT_ID: !Sub "${AWS::AccountId}"
        REGION: !Ref "${AWS::Region}"
        ENVIRONMENT: !Ref Environment
        PARTNER_KEY: "TEKION"
        LOGLEVEL: INFO
        SECRET_MANAGER_ID: !Ref SecretsManagerId

Resources:
  TekionTokenRotationQueueDLQ:
    Type: AWS::SQS::Queue

  TekionTokenRotationQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'tekion-token-rotation-failures-queue-${Environment}'
      VisibilityTimeout: 3600
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt TekionTokenRotationQueueDLQ.Arn
        maxReceiveCount: 5

  TekionTokenRotationFunctionRule:
    Type: AWS::Events::Rule
    Properties:
      Description: Nightly trigger for InvokeTekionTokenRotationFunction
      ScheduleExpression: cron(0 22 * * ? *)  # Schedule for 10pm UTC every day
      State: !If [ IsProd, ENABLED, DISABLED ]
      Targets:
        - Arn: !GetAtt TekionTokenRotationQueue.Arn
          Id: TekionTokenRotationQueue
          # RoleArn: !GetAtt StateMachineTriggerRole.Arn

  TekionTokenRotationEventMapping:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      BatchSize: 1
      EventSourceArn: !GetAtt TekionTokenRotationQueue.Arn
      MaximumBatchingWindowInSeconds: 1
      FunctionName: !GetAtt InvokeTekionTokenRotationFunction.Arn

  InvokeTekionTokenRotationFunction:
    Type: AWS::Serverless::Function
    Properties:
      Description: Invoke Tekion's token rotation
      CodeUri: app/
      Handler: access_token.lambda_handler
      Timeout: 180
      Policies:
        - Id: FunctionPermissions
          Version: "2012-10-17"
          Statement:
            - Sid: AllowS3
              Effect: Allow
              Action:
                - s3:GetObject
                - s3:PutObject
              Resource:
                - !If [ IsProd,
                  !Sub "arn:aws:s3:::auth-service-${AWS::Region}-prod/*",
                  !Sub "arn:aws:s3:::auth-service-${AWS::Region}-test/*"
                ]
            - Sid: AllowSecrets
              Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource:
                - !If [ IsProd,
                  !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:prod/crm-integrations-partner*",
                  !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:test/crm-integrations-partner*",
                ]
      Environment:
        Variables:
          ENVIRONMENT: !Ref Environment
          TEKION_AUTH_FILE_PATH: !Ref TekionAuthFilePath
          SECRET_MANAGER_ID: !Ref SecretsManagerId

  InvokeTekionTokenRotationErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub tekion-token-rotation-error-${Environment}
      AlarmDescription: There are messages in the Tekion token rotation error
      ActionsEnabled: true
      AlarmActions:
        - !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:alert_client_engineering"
      Dimensions:
        - Name: FunctionName
          Value: !Ref InvokeTekionTokenRotationFunction
      EvaluationPeriods: 1
      MetricName: Errors
      Namespace: AWS/Lambda
      Period: 900
      Statistic: Sum
      Threshold: 3
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  TekionTokenRotationQueueDLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: IsProd
    Properties:
      AlarmName: !Sub TekionTokenRotationQueueDLQ-${Environment}
      AlarmDescription: There are messages in the Tekion token rotation order DLQ
      ActionsEnabled: true
      AlarmActions:
        - !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:alert_client_engineering"
      Dimensions:
        - Name: QueueName
          Value: !GetAtt TekionTokenRotationQueueDLQ.QueueName
      EvaluationPeriods: 1
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Period: 300
      Statistic: Sum
      ComparisonOperator: GreaterThanThreshold
      Threshold: 0
      TreatMissingData: notBreaching
